<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Export Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>PDF Export Functionality Test</h1>
    
    <div class="test-section">
        <h2>Backend API Test</h2>
        <p>Test the backend PDF export endpoints directly:</p>
        <button onclick="testBackendConnection()">Test Backend Connection</button>
        <button onclick="testPDFEndpoint()">Test PDF Export Endpoint</button>
        <div id="backend-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Debug Information</h2>
        <p>Current configuration:</p>
        <ul>
            <li>Backend URL: <span id="backend-url">http://localhost:8080</span></li>
            <li>Frontend URL: <span id="frontend-url">http://localhost:3001</span></li>
            <li>Test Report ID: <span id="test-report-id">1</span></li>
        </ul>
        <button onclick="getReports()">Get Available Reports</button>
        <div id="reports-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>PDF Export Test</h2>
        <p>Test the PDF export with actual data:</p>
        <input type="number" id="reportId" placeholder="Report ID" value="1" min="1">
        <button onclick="exportSingleReport()">Export Single Report</button>
        <button onclick="exportMultipleReports()">Export Multiple Reports</button>
        <div id="export-result" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        function updateResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isError ? 'result error' : 'result success';
        }

        async function testBackendConnection() {
            try {
                const response = await fetch(`${API_BASE}/public/reports/categories`);
                if (response.ok) {
                    const data = await response.json();
                    updateResult('backend-result', `‚úÖ Backend connected! Categories: ${data.join(', ')}`);
                } else {
                    updateResult('backend-result', `‚ùå Backend responded with status: ${response.status}`, true);
                }
            } catch (error) {
                updateResult('backend-result', `‚ùå Cannot connect to backend: ${error.message}`, true);
            }
        }

        async function testPDFEndpoint() {
            try {
                // First try to get a auth token (this is just a test)
                updateResult('backend-result', 'üîÑ Testing PDF endpoint (no auth)...');
                
                const response = await fetch(`${API_BASE}/reports/test-pdf`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain'
                    }
                });
                
                if (response.ok) {
                    const text = await response.text();
                    updateResult('backend-result', `‚úÖ PDF endpoint working! Response: ${text.substring(0, 100)}...`);
                } else {
                    updateResult('backend-result', `‚ö†Ô∏è PDF endpoint responded with status: ${response.status} (might need authentication)`, true);
                }
            } catch (error) {
                updateResult('backend-result', `‚ùå PDF endpoint error: ${error.message}`, true);
            }
        }

        async function getReports() {
            try {
                const response = await fetch(`${API_BASE}/public/reports`);
                if (response.ok) {
                    const data = await response.json();
                    const reports = data.content || data;
                    if (reports && reports.length > 0) {
                        const reportList = reports.slice(0, 3).map(r => `ID: ${r.id}, Title: ${r.title}`).join('; ');
                        updateResult('reports-result', `‚úÖ Found ${reports.length} reports. First 3: ${reportList}`);
                        document.getElementById('test-report-id').textContent = reports[0].id;
                        document.getElementById('reportId').value = reports[0].id;
                    } else {
                        updateResult('reports-result', '‚ö†Ô∏è No reports found in database', true);
                    }
                } else {
                    updateResult('reports-result', `‚ùå Cannot get reports: ${response.status}`, true);
                }
            } catch (error) {
                updateResult('reports-result', `‚ùå Error getting reports: ${error.message}`, true);
            }
        }

        async function exportSingleReport() {
            const reportId = document.getElementById('reportId').value;
            try {
                updateResult('export-result', 'üîÑ Attempting to export single report...');
                
                const response = await fetch(`${API_BASE}/reports/${reportId}/export/pdf`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/pdf'
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `test_report_${reportId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    updateResult('export-result', `‚úÖ Single report exported successfully! Size: ${blob.size} bytes`);
                } else {
                    updateResult('export-result', `‚ùå Export failed with status: ${response.status}`, true);
                }
            } catch (error) {
                updateResult('export-result', `‚ùå Export error: ${error.message}`, true);
            }
        }

        async function exportMultipleReports() {
            try {
                updateResult('export-result', 'üîÑ Attempting to export multiple reports...');
                
                const response = await fetch(`${API_BASE}/reports/export/pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/pdf'
                    },
                    body: JSON.stringify({
                        reportIds: [1, 2, 3], // These will be handled as integers in JSON
                        options: {
                            includeImages: true,
                            includeComments: true,
                            includeProgress: true,
                            includeMetadata: true,
                            format: 'detailed'
                        }
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'test_multiple_reports.pdf'; // Back to PDF extension
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    updateResult('export-result', `‚úÖ Multiple reports exported successfully! Size: ${blob.size} bytes`);
                } else {
                    const errorText = await response.text();
                    updateResult('export-result', `‚ùå Multiple export failed with status: ${response.status}. Error: ${errorText}`, true);
                }
            } catch (error) {
                updateResult('export-result', `‚ùå Multiple export error: ${error.message}`, true);
            }
        }

        // Auto-test on page load
        window.onload = function() {
            setTimeout(testBackendConnection, 500);
            setTimeout(getReports, 1000);
        };
    </script>
</body>
</html>

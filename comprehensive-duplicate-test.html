<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Duplicate Test</title>
</head>
<body>
    <h1>Comprehensive Duplicate Detection Test</h1>
    
    <div>
        <h2>Step 1: Test Backend Duplicate Detection</h2>
        <button onclick="testBackend()">Test Backend Duplicate Check</button>
        <pre id="backendResult"></pre>
    </div>
    
    <div>
        <h2>Step 2: Test with Different Locations</h2>
        <button onclick="testDifferentLocations()">Test Different Locations</button>
        <pre id="locationResult"></pre>
    </div>
    
    <div>
        <h2>Step 3: Check Recent Reports</h2>
        <button onclick="checkRecentReports()">Check Recent Reports</button>
        <pre id="reportsResult"></pre>
    </div>

    <script>
        async function testBackend() {
            const testData = {
                title: "Test Road Issue",
                description: "Large pothole on Main Street causing damage",
                category: "ROADS_INFRASTRUCTURE",
                latitude: 23.8103,
                longitude: 90.4125
            };

            try {
                const response = await fetch('http://localhost:8080/api/reports/check-duplicates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                document.getElementById('backendResult').textContent = 
                    'Backend Test Result:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('backendResult').textContent = 'Error: ' + error.message;
            }
        }

        async function testDifferentLocations() {
            const tests = [
                {
                    name: "Exact same location",
                    data: {
                        title: "Another road issue",
                        description: "Another pothole issue",
                        category: "ROADS_INFRASTRUCTURE",
                        latitude: 23.8103,
                        longitude: 90.4125
                    }
                },
                {
                    name: "Nearby location (1km away)",
                    data: {
                        title: "Nearby road issue",
                        description: "Similar pothole problem",
                        category: "ROADS_INFRASTRUCTURE",
                        latitude: 23.8113,
                        longitude: 90.4135
                    }
                },
                {
                    name: "Far location",
                    data: {
                        title: "Far road issue",
                        description: "Different pothole",
                        category: "ROADS_INFRASTRUCTURE",
                        latitude: 23.9000,
                        longitude: 90.5000
                    }
                }
            ];

            let results = "Location Tests:\n\n";
            
            for (const test of tests) {
                try {
                    const response = await fetch('http://localhost:8080/api/reports/check-duplicates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(test.data)
                    });
                    
                    const data = await response.json();
                    results += `${test.name}:\n`;
                    results += `  Has Duplicates: ${data.hasDuplicates}\n`;
                    results += `  Duplicate Count: ${data.duplicateCount}\n`;
                    if (data.duplicates && data.duplicates.length > 0) {
                        results += `  First Duplicate Similarity: ${data.duplicates[0].similarity}%\n`;
                    }
                    results += '\n';
                } catch (error) {
                    results += `${test.name}: Error - ${error.message}\n\n`;
                }
            }
            
            document.getElementById('locationResult').textContent = results;
        }

        async function checkRecentReports() {
            try {
                const response = await fetch('http://localhost:8080/api/public/reports?limit=10', {
                    method: 'GET'
                });
                
                const data = await response.json();
                let result = `Recent Reports (${data.content ? data.content.length : 0} found):\n\n`;
                
                if (data.content) {
                    data.content.forEach((report, index) => {
                        result += `${index + 1}. ID: ${report.id}\n`;
                        result += `   Title: ${report.title}\n`;
                        result += `   Category: ${report.category}\n`;
                        result += `   Location: ${report.latitude}, ${report.longitude}\n`;
                        result += `   Created: ${new Date(report.createdAt).toLocaleString()}\n\n`;
                    });
                }
                
                document.getElementById('reportsResult').textContent = result;
            } catch (error) {
                document.getElementById('reportsResult').textContent = 'Error: ' + error.message;
            }
        }

        // Auto-run tests
        window.onload = function() {
            testBackend();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .success {
            background-color: #28a745;
        }
        .success:hover {
            background-color: #1e7e34;
        }
        .results {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ”” FixPoint Notification System Test</h1>
        
        <div class="status info">
            <strong>Frontend:</strong> http://localhost:3000/FixPoint<br>
            <strong>Backend:</strong> http://localhost:8080<br>
            <strong>WebSocket:</strong> ws://localhost:8080/ws (proxied through frontend)<br>
            <strong>Status:</strong> âœ… Both servers running with proxy configuration
        </div>

        <div class="test-section">
            <h3>âœ… Notification Dropdown Visibility Test</h3>
            <p>Test if the notification dropdown appears correctly with the new CSS fixes:</p>
            <ol>
                <li>Open the frontend application: <a href="http://localhost:3000/FixPoint" target="_blank">http://localhost:3000/FixPoint</a></li>
                <li>Login with any user credentials</li>
                <li>Look for the notification bell icon in the navbar</li>
                <li>Click the notification bell to test dropdown visibility</li>
                <li>The dropdown should appear on top of all other elements with maximum z-index (2147483647)</li>
            </ol>
            <div class="status success" style="margin-top: 10px;">
                <strong>Expected Result:</strong> Notification dropdown should be fully visible and not hidden behind other UI elements.
            </div>
        </div>

        <div class="test-section">
            <h3>ðŸš€ Backend Notification API Test</h3>
            <p>Test the notification creation through backend API:</p>
            <button class="button" onclick="testCreateNotification()">Create Test Notification</button>
            <button class="button" onclick="testFetchNotifications()">Fetch Notifications</button>
            <button class="button" onclick="testWebSocketConnection()">Test WebSocket</button>
            <div class="results" id="apiResults"></div>
        </div>

        <div class="test-section">
            <h3>ðŸ”— WebSocket Real-time Test</h3>
            <p>Test real-time notification delivery:</p>
            <button class="button success" onclick="connectWebSocket()">Connect WebSocket</button>
            <button class="button" onclick="simulateRealtimeNotification()">Simulate Real-time Notification</button>
            <div class="status" id="wsStatus">Click "Connect WebSocket" to start</div>
            <div class="results" id="wsResults"></div>
        </div>

        <div class="test-section">
            <h3>ðŸ“‹ CSS Z-index Verification</h3>
            <p>Verify that the CSS overrides are working:</p>
            <button class="button" onclick="checkCSSOverrides()">Check CSS Z-index Values</button>
            <div class="results" id="cssResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let ws = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            element.innerHTML += logEntry;
            element.scrollTop = element.scrollHeight;
        }

        async function testCreateNotification() {
            log('apiResults', 'Testing notification creation...', 'info');
            try {
                const response = await fetch(`${API_BASE}/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify({
                        userId: 1,
                        message: 'Test notification from API test',
                        type: 'TEST',
                        reportId: null
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('apiResults', `âœ… Notification created: ${JSON.stringify(result)}`, 'success');
                } else {
                    log('apiResults', `âŒ Failed to create notification: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('apiResults', `âŒ Error: ${error.message}`, 'error');
            }
        }

        async function testFetchNotifications() {
            log('apiResults', 'Fetching notifications...', 'info');
            try {
                const response = await fetch(`${API_BASE}/notifications/user/1`, {
                    headers: {
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    }
                });
                
                if (response.ok) {
                    const notifications = await response.json();
                    log('apiResults', `âœ… Found ${notifications.length} notifications:`, 'success');
                    notifications.slice(0, 5).forEach(n => {
                        log('apiResults', `  - ${n.message} (${n.type})`, 'info');
                    });
                } else {
                    log('apiResults', `âŒ Failed to fetch notifications: ${response.status}`, 'error');
                }
            } catch (error) {
                log('apiResults', `âŒ Error: ${error.message}`, 'error');
            }
        }

        async function testWebSocketConnection() {
            log('apiResults', 'Testing WebSocket endpoint...', 'info');
            try {
                const testWs = new WebSocket('ws://localhost:8080/ws');
                
                testWs.onopen = () => {
                    log('apiResults', 'âœ… WebSocket connection successful!', 'success');
                    testWs.close();
                };
                
                testWs.onerror = (error) => {
                    log('apiResults', `âŒ WebSocket error: ${error}`, 'error');
                };
                
                testWs.onclose = () => {
                    log('apiResults', 'ðŸ”Œ WebSocket connection closed', 'info');
                };
                
            } catch (error) {
                log('apiResults', `âŒ WebSocket test error: ${error.message}`, 'error');
            }
        }

        function connectWebSocket() {
            if (ws) {
                ws.close();
            }
            
            const wsStatus = document.getElementById('wsStatus');
            wsStatus.className = 'status info';
            wsStatus.textContent = 'Connecting to WebSocket...';
            
            try {
                ws = new WebSocket('ws://localhost:8080/ws');
                
                ws.onopen = () => {
                    wsStatus.className = 'status success';
                    wsStatus.textContent = 'âœ… WebSocket Connected Successfully';
                    log('wsResults', 'ðŸ”— Connected to WebSocket server', 'success');
                    
                    // Subscribe to user notifications
                    const subscribeMessage = {
                        type: 'SUBSCRIBE',
                        destination: '/user/1/notifications'
                    };
                    ws.send(JSON.stringify(subscribeMessage));
                    log('wsResults', 'ðŸ“¡ Subscribed to user notifications', 'info');
                };
                
                ws.onmessage = (event) => {
                    log('wsResults', `ðŸ“¨ Received: ${event.data}`, 'success');
                };
                
                ws.onerror = (error) => {
                    wsStatus.className = 'status error';
                    wsStatus.textContent = 'âŒ WebSocket Connection Failed';
                    log('wsResults', `âŒ WebSocket error: ${error}`, 'error');
                };
                
                ws.onclose = () => {
                    wsStatus.className = 'status info';
                    wsStatus.textContent = 'ðŸ”Œ WebSocket Disconnected';
                    log('wsResults', 'ðŸ”Œ WebSocket connection closed', 'info');
                };
                
            } catch (error) {
                wsStatus.className = 'status error';
                wsStatus.textContent = 'âŒ Failed to connect';
                log('wsResults', `âŒ Connection error: ${error.message}`, 'error');
            }
        }

        async function simulateRealtimeNotification() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('wsResults', 'âŒ WebSocket not connected. Connect first!', 'error');
                return;
            }
            
            log('wsResults', 'ðŸš€ Simulating real-time notification...', 'info');
            
            // Create a notification through API which should trigger WebSocket delivery
            try {
                const response = await fetch(`${API_BASE}/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify({
                        userId: 1,
                        message: 'Real-time test notification via WebSocket',
                        type: 'REALTIME_TEST',
                        reportId: null
                    })
                });
                
                if (response.ok) {
                    log('wsResults', 'âœ… Notification sent to backend - waiting for WebSocket delivery...', 'success');
                } else {
                    log('wsResults', `âŒ Failed to send notification: ${response.status}`, 'error');
                }
            } catch (error) {
                log('wsResults', `âŒ Error sending notification: ${error.message}`, 'error');
            }
        }

        function checkCSSOverrides() {
            log('cssResults', 'Checking CSS z-index values...', 'info');
            
            // Check if our CSS files are loaded
            const styleSheets = document.styleSheets;
            let foundOverrides = false;
            
            log('cssResults', `ðŸ“„ Found ${styleSheets.length} stylesheets`, 'info');
            
            // We can't directly check external stylesheets due to CORS, but we can suggest manual checks
            log('cssResults', 'ðŸ” To verify CSS overrides manually:', 'info');
            log('cssResults', '1. Open browser DevTools (F12)', 'info');
            log('cssResults', '2. Go to Elements tab', 'info');
            log('cssResults', '3. Find .notification-center-overlay element', 'info');
            log('cssResults', '4. Check z-index value should be 2147483647 !important', 'info');
            log('cssResults', '5. Find .notification-center element', 'info');
            log('cssResults', '6. Check z-index value should be 2147483647 !important', 'info');
            
            // Check if NotificationOverrides.css is included in the app
            const links = document.querySelectorAll('link[rel="stylesheet"]');
            let overrideCSSFound = false;
            links.forEach(link => {
                if (link.href.includes('NotificationOverrides')) {
                    overrideCSSFound = true;
                }
            });
            
            if (overrideCSSFound) {
                log('cssResults', 'âœ… NotificationOverrides.css found!', 'success');
            } else {
                log('cssResults', 'âš ï¸ NotificationOverrides.css not detected in this page', 'info');
                log('cssResults', '   (This is expected - check the main app)', 'info');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('apiResults', 'Notification System Test initialized', 'info');
            log('wsResults', 'WebSocket test ready', 'info');
            log('cssResults', 'CSS checker ready', 'info');
        });
    </script>
</body>
</html>
